name: Deploy Zenv Hub to GitHub Pages

on:
  # DÃ©clencheur sur push vers la branche main
  push:
    branches: [ main, master ]
  
  # DÃ©clencheur manuel
  workflow_dispatch:
    inputs:
      message:
        description: 'Message de dÃ©ploiement'
        required: false
        default: 'DÃ©ploiement manuel'
  
  # DÃ©clencheur sur pull request
  pull_request:
    branches: [ main, master ]

# Permissions pour GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Concurrence : un seul dÃ©ploiement Ã  la fois
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Job de build
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # RÃ©cupÃ©rer tout l'historique
        
    - name: ðŸ› ï¸ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2' # Version compatible avec Jekyll
        bundler-cache: true
        
    - name: ðŸ“¦ Installer les dÃ©pendances
      run: |
        # CrÃ©er un Gemfile si inexistant
        if [ ! -f Gemfile ]; then
          cat > Gemfile << 'EOF'
source "https://rubygems.org"

gem "jekyll", "~> 4.3"
gem "jekyll-feed", "~> 0.17"
gem "jekyll-sitemap", "~> 1.4"
gem "kramdown-parser-gfm", "~> 1.1"
gem "webrick", "~> 1.8"

# ThÃ¨me par dÃ©faut
gem "minima", "~> 2.5"
EOF
        fi
        
        # VÃ©rifier si _config.yml existe
        if [ ! -f _config.yml ]; then
          echo "CrÃ©ation de _config.yml par dÃ©faut..."
          cat > _config.yml << 'EOF'
title: "Zenv Package Hub"
description: "Interface web pour Zenv Package Hub"
baseurl: ""
url: "https://zenv-hub.github.io"

markdown: kramdown
theme: minima
plugins:
  - jekyll-feed

zenv_hub:
  api_url: "https://zenv-hub.onrender.com"
  version: "2.1.0"

navigation:
  - title: "Accueil"
    url: "/"
  - title: "Packages"
    url: "/packages/"
  - title: "Badges"
    url: "/badges/"
  - title: "API Docs"
    url: "/api/"

include:
  - _assets
EOF
        fi
        
        # Installer les gems
        bundle install
        
    - name: ðŸ—ï¸ Construire le site Jekyll
      run: |
        # Construire le site
        bundle exec jekyll build
        
        # VÃ©rifier que le site est bien construit
        if [ -d "_site" ]; then
          echo "âœ… Site construit avec succÃ¨s"
          echo "Fichiers gÃ©nÃ©rÃ©s:"
          find _site -type f -name "*.html" | head -10
        else
          echo "âŒ Ã‰chec de la construction"
          exit 1
        fi
        
    - name: ðŸ“ Ajouter un fichier .nojekyll
      run: |
        # Ce fichier indique Ã  GitHub Pages de ne pas utiliser Jekyll
        touch _site/.nojekyll
        
    - name: ðŸ“Š GÃ©nÃ©rer un rapport
      run: |
        echo "=== Rapport de build ==="
        echo "RÃ©pertoire de sortie: _site"
        echo "Nombre de fichiers HTML: $(find _site -name "*.html" | wc -l)"
        echo "Taille totale: $(du -sh _site | cut -f1)"
        
    - name: ðŸ’¾ Upload les artefacts
      uses: actions/upload-pages-artifact@v3
      with:
        name: github-pages
        path: _site/
        
  # Job de dÃ©ploiement (seulement sur push vers main)
  deploy:
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸš€ DÃ©ployer sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
